<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CCC計算ツール | r2</title>
<link rel="icon" href="favicon192192.png">
<style>
  :root{
    --brand:#578899; --ink:#222; --muted:#666; --bg:#f7f9fb; --card:#fff;
    --ok:#1a7f37; --warn:#c0362c; --line:#e6eef3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"ヒラギノ角ゴ ProN","Noto Sans JP",sans-serif;color:var(--ink);background:var(--bg)}
  header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  header img.logo{height:48px}
  header h1{margin:0;font-weight:700;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:clamp(16px,3.5vw,20px)}
  header .ver{margin-left:auto;font-size:12px;color:var(--muted)}
  main{max-width:920px;margin:16px auto;padding:0 12px 72px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .card h2{font-size:16px;margin:0 0 10px;color:var(--brand)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--muted);display:block;margin:6px 0 4px}
  input[type="text"]{width:100%;padding:10px 12px;border:1px solid #cfd9e3;border-radius:10px;font-size:16px}
  input[type="text"]:focus{outline:2px solid color-mix(in oklab,var(--brand),white 70%)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1.8px solid var(--brand);padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;user-select:none;background:transparent;color:var(--ink)}
  .chip[data-active="true"]{background:var(--brand);color:#fff;font-weight:700;border-width:2.2px}
  .sub{font-size:12px;color:var(--muted)}
  .btn-card{display:flex;flex-wrap:wrap;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  button{cursor:pointer;border:1px solid #d7e2ea;background:#fff;padding:9px 12px;border-radius:10px;font-size:14px}
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .kpi{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
  .metric{border:1px dashed #d7e2ea;border-radius:12px;padding:12px}
  .metric .name{font-size:12px;color:var(--muted)}
  .metric .value{font-size:24px;font-weight:800;margin-top:4px}
  .metric.ok .value{color:var(--ok)}
  .metric.warn .value{color:var(--warn)}
  .bar{height:12px;border-radius:999px;background:#e9eef2;position:relative;overflow:hidden;margin-top:8px}
  .bar span{position:absolute;top:0;left:0;height:100%}
  .seg-dio{background:#b8d0db}
  .seg-dso{background:#8fb6c6}
  .seg-dpo{background:#7aa0b1}
  details summary{cursor:pointer;color:var(--brand);font-weight:600}
  footer{margin-top:18px;font-size:12px;color:var(--muted);text-align:center}
  a.link{color:var(--brand);text-decoration:underline}
</style>
</head>
<body>
<header>
  <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">
    <img src="ロゴ.jpg" alt="松本会計" class="logo">
  </a>
  <h1>CCC（キャッシュ・コンバージョン・サイクル）計算ツール</h1>
  <span class="ver">r2</span>
</header>

<main>
  <!-- イントロ＆モード切替 -->
  <div class="card" id="intro">
    <div class="chips" id="modeChips" role="tablist" aria-label="入力モード">
      <span class="chip" data-value="direct" data-active="true">① DIO/DSO/DPOを直接入力</span>
      <span class="chip" data-value="auto">② 財務数値から自動算出</span>
    </div>
    <div class="chips" id="daysChips" style="margin-top:8px">
      <span class="chip" data-days="365" data-active="true">期間日数 365</span>
      <span class="chip" data-days="360">360</span>
    </div>
    <p class="sub">CCC＝DIO＋DSO－DPO（在庫回転日数＋売上債権回転日数－仕入債務回転日数）。同業比較や自社推移で評価します</p>
  </div>

  <!-- ① 直接入力 -->
  <div class="card" id="directBox">
    <h2>① 直接入力</h2>
    <div class="row">
      <div>
        <label>在庫回転日数（DIO / 日）</label>
        <input type="text" inputmode="decimal" placeholder="例）45" id="dioInput">
      </div>
      <div>
        <label>売上債権回転日数（DSO / 日）</label>
        <input type="text" inputmode="decimal" placeholder="例）35" id="dsoInput">
      </div>
      <div>
        <label>仕入債務回転日数（DPO / 日）</label>
        <input type="text" inputmode="decimal" placeholder="例）30" id="dpoInput">
      </div>
    </div>
  </div>

  <!-- ② 自動算出 -->
  <div class="card" id="autoBox" style="display:none">
    <h2>② 財務数値から自動算出</h2>
    <div class="chips" id="avgChips" style="margin-bottom:8px">
      <span class="chip" data-avg="avg" data-active="true">平均残高を使用</span>
      <span class="chip" data-avg="end">期末残高でも可</span>
    </div>
    <div class="row">
      <div>
        <label>売上高（期間合計）</label>
        <input type="text" inputmode="numeric" placeholder="例）100,000,000" id="sales">
      </div>
      <div>
        <label>売上原価（期間合計）</label>
        <input type="text" inputmode="numeric" placeholder="例）60,000,000" id="cogs">
      </div>
      <div>
        <label>売上債権（売掛＋手形）平均</label>
        <input type="text" inputmode="numeric" placeholder="例）9,500,000" id="ar">
      </div>
      <div>
        <label>棚卸資産 平均</label>
        <input type="text" inputmode="numeric" placeholder="例）7,400,000" id="inv">
      </div>
      <div>
        <label>仕入債務（買掛＋手形）平均</label>
        <input type="text" inputmode="numeric" placeholder="例）4,800,000" id="ap">
      </div>
    </div>
    <p class="sub">式：DSO＝売上債権/売上高×日数、DIO＝棚卸資産/売上原価×日数、DPO＝仕入債務/売上原価×日数</p>
  </div>

  <!-- 結果 -->
  <div class="card" id="result">
    <h2>結果</h2>
    <div class="kpi">
      <div class="metric" id="mDIO"><div class="name">DIO（在庫）</div><div class="value" id="vDIO">— 日</div></div>
      <div class="metric" id="mDSO"><div class="name">DSO（売上債権）</div><div class="value" id="vDSO">— 日</div></div>
      <div class="metric" id="mDPO"><div class="name">DPO（仕入債務）</div><div class="value" id="vDPO">— 日</div></div>
      <div class="metric" id="mCCC"><div class="name">CCC</div><div class="value" id="vCCC">— 日</div></div>
    </div>

    <div style="margin-top:10px">
      <div class="bar" title="DIO + DSO の合計">
        <span class="seg-dio" id="segDIO" style="width:0%"></span>
        <span class="seg-dso" id="segDSO" style="width:0%"></span>
      </div>
      <div class="bar" title="DPO">
        <span class="seg-dpo" id="segDPO" style="width:0%"></span>
      </div>
      <p class="sub" id="comment">入力すると自動計算します（単位：日）。CCCが小さいほど運転資金効率は良好。負の場合は仕入先信用で回っている状態です。</p>
    </div>
  </div>

  <!-- 操作ボタン（白背景カード） -->
  <div class="btn-card" id="btns">
    <button class="primary" id="copyBtn">結果をコピー</button>
    <button id="resetBtn">リセット</button>
    <button id="printBtn">印刷 / PDF保存</button>
    <button id="csvBtn">CSV</button>
    <button id="helpBtn">解説</button>
  </div>

  <!-- ステップバック（事前確認） -->
  <details class="card">
    <summary>ステップバック（入力前に確認すること）</summary>
    <ul class="sub">
      <li>期間日数は<strong>365日</strong>か<strong>360日</strong>か（社内基準）</li>
      <li>残高は原則<strong>平均（期首・期末平均）</strong>。難しければ期末残高で代替</li>
      <li>売上債権＝受取手形＋売掛金、仕入債務＝支払手形＋買掛金（前受金などは含めない）</li>
      <li>業種差が大きいので、同業比較／自社推移で評価する</li>
    </ul>
  </details>

  <!-- 解説 -->
  <div class="card" id="guide" style="display:none">
    <h2>解説（用語と式）</h2>
    <ul class="sub">
      <li><strong>CCC（Cash Conversion Cycle）</strong>：在庫→販売→回収までの純期間。式は<strong>CCC＝DIO＋DSO－DPO</strong>。短いほど良く、<strong>負のCCC</strong>（回収が支払いより先行）もあり得ます。</li>
      <li><strong>DIO（Days Inventory Outstanding / 在庫回転日数）</strong>：在庫が売上原価へ転化するまでの平均日数。式は<strong>DIO＝棚卸資産÷（売上原価÷日数）</strong>。</li>
      <li><strong>DSO（Days Sales Outstanding / 売上債権回転日数）</strong>：売上発生から入金回収までの平均日数。式は<strong>DSO＝売上債権÷（売上高÷日数）</strong>。</li>
      <li><strong>DPO（Days Payables Outstanding / 仕入債務回転日数）</strong>：仕入から支払までの平均日数。式は<strong>DPO＝仕入債務÷（売上原価÷日数）</strong>。</li>
      <li>残高は原則「平均残高」を用いると実務的に安定（期末のみでも可）。</li>
      <li>改善の考え方：DIO短縮（在庫最適化）、DSO短縮（回収サイト短縮）、DPO延長（支払サイトの適正化）など。</li>
    </ul>
    <p class="sub">※詳しい定義・式の出典は本ファイル末尾の「参考文献」を参照</p>
  </div>

  <!-- 参考文献 -->
  <details class="card">
    <summary>参考文献（外部リンク）</summary>
    <ul class="sub">
      <li><a class="link" href="https://mba.globis.ac.jp/about_mba/glossary/detail-20621.html" target="_blank" rel="noopener">CCCの定義・式（グロービス）</a></li>
      <li><a class="link" href="https://www.blackline.jp/resources/glossaries/days-sales-outstanding.html" target="_blank" rel="noopener">DSOの定義・式（BlackLine）</a></li>
      <li><a class="link" href="https://mba.globis.ac.jp/about_mba/glossary/detail-12225.html" target="_blank" rel="noopener">DPOの式（仕入債務回転期間）（グロービス）</a></li>
      <li><a class="link" href="https://biz.moneyforward.com/accounting/basic/46837/" target="_blank" rel="noopener">DIO（棚卸資産回転期間）の式（マネーフォワード）</a></li>
    </ul>
  </details>

  <footer>
    © <a class="link" href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">税理士法人松本会計事務所</a>
  </footer>
</main>

<script>
(function(){
  const nfInt = new Intl.NumberFormat('ja-JP');
  const nf1 = new Intl.NumberFormat('ja-JP',{maximumFractionDigits:1,minimumFractionDigits:0});
  const $ = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const state = {mode:'direct', days:365};

  // --- chip toggles ---
  function setActive(groupSel, el){
    $$(groupSel+' .chip').forEach(c=>c.dataset.active="false");
    el.dataset.active="true";
  }
  $$('#modeChips .chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      setActive('#modeChips', ch);
      state.mode=ch.dataset.value;
      $('#directBox').style.display = state.mode==='direct'?'block':'none';
      $('#autoBox').style.display   = state.mode==='auto'  ?'block':'none';
      calc();
    });
  });
  $$('#daysChips .chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      setActive('#daysChips', ch);
      state.days = Number(ch.dataset.days)||365;
      calc();
    });
  });
  $$('#avgChips .chip').forEach(ch=>{
    ch.addEventListener('click',()=>{ setActive('#avgChips', ch); });
  });

  // --- numeric input handling with live comma & caret keep ---
  function digits(s){return (s||'').replace(/[^\d.-]/g,'');}
  function parseNum(s){const t=digits(s); if(t===''||t==='-'||t==='.'||t==='-.') return NaN; return Number(t);}
  function formatTextInputKeepCaret(el,{decimals=0}={}){
    const raw = el.value;
    const sel = el.selectionStart||raw.length;
    const leftDigits = raw.slice(0,sel).replace(/[^\d]/g,'').length;
    let val = parseNum(raw);
    if(isNaN(val)) val = '';
    const formatted = (val===''? '' :
      (decimals===0? nfInt.format(Math.trunc(val)) : Number(val).toFixed(decimals)));
    el.value = formatted;
    // restore caret near same digit index
    let pos=0, seen=0;
    for(let i=0;i<formatted.length;i++){
      if(/\d/.test(formatted[i])) seen++;
      if(seen>=leftDigits){pos=i+1;break;}
    }
    el.setSelectionRange(pos,pos);
  }

  // bind inputs
  ['dioInput','dsoInput','dpoInput','sales','cogs','ar','inv','ap'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input',()=>{
      const decimals = (id.includes('Input'))?1:0; // allow 1 decimal for DIO/DSO/DPO
      formatTextInputKeepCaret(el,{decimals: decimals?1:0});
      calc();
    });
    el.addEventListener('blur',()=>calc());
  });

  function valNum(id){ const v=parseNum($('#'+id)?.value); return isNaN(v)?0: v; }

  function setSegWidths(dio,dso,dpo){
    const max = Math.max(10, dio+dso, dpo); // avoid 0-width
    $('#segDIO').style.width = (dio/max*100)+'%';
    $('#segDSO').style.left  = (dio/max*100)+'%';
    $('#segDSO').style.width = (dso/max*100)+'%';
    $('#segDPO').style.width = (dpo/max*100)+'%';
  }

  function calc(){
    let dio=0,dso=0,dpo=0, ccc=0;
    const days = state.days;

    if(state.mode==='direct'){
      dio = Math.max(0, parseNum($('#dioInput').value)||0);
      dso = Math.max(0, parseNum($('#dsoInput').value)||0);
      dpo = Math.max(0, parseNum($('#dpoInput').value)||0);
    }else{
      const sales=valNum('sales'); const cogs=valNum('cogs');
      const ar=valNum('ar'); const inv=valNum('inv'); const ap=valNum('ap');
      dso = (sales>0 && ar>=0) ? (ar / sales) * days : 0;
      dio = (cogs>0  && inv>=0) ? (inv / cogs) * days : 0;
      dpo = (cogs>0  && ap>=0) ? (ap / cogs) * days : 0;
    }
    ccc = dio + dso - dpo;

    // show
    $('#vDIO').textContent = (dio? nf1.format(dio):'—')+' 日';
    $('#vDSO').textContent = (dso? nf1.format(dso):'—')+' 日';
    $('#vDPO').textContent = (dpo? nf1.format(dpo):'—')+' 日';
    $('#vCCC').textContent = ( (dio||dso||dpo)? nf1.format(ccc):'—')+' 日';

    // coloring CCC
    const mCCC = $('#mCCC'); mCCC.classList.remove('ok','warn');
    if(dio||dso||dpo){ (ccc<=0? mCCC.classList.add('ok') : mCCC.classList.add('warn')); }

    setSegWidths(Math.max(dio,0), Math.max(dso,0), Math.max(dpo,0));

    // comment
    const msg = (dio||dso||dpo)
      ? (ccc<=0
          ? `CCC=${nf1.format(ccc)}日：仕入先信用（DPO）が回収（DIO+DSO）を上回っており、持ち出しは生じていません`
          : `CCC=${nf1.format(ccc)}日：支払から回収まで平均${nf1.format(ccc)}日を要し、その間の運転資金が必要です`)
      : '入力すると自動計算します（単位：日）。CCCが小さいほど運転資金効率は良好。負の場合は仕入先信用で回っています。';
    $('#comment').textContent = msg;
  }

  // buttons
  $('#copyBtn').addEventListener('click',()=>{
    const t = [
      `【CCC結果】`,
      `DIO：${$('#vDIO').textContent}`,
      `DSO：${$('#vDSO').textContent}`,
      `DPO：${$('#vDPO').textContent}`,
      `CCC：${$('#vCCC').textContent}`,
      `(日数基準：${state.days}日, モード：${state.mode==='direct'?'直接入力':'自動算出'})`
    ].join('\n');
    navigator.clipboard.writeText(t).then(()=>{ alert('結果をコピーしました'); });
  });
  $('#resetBtn').addEventListener('click',()=>{
    $$('input[type="text"]').forEach(el=>el.value='');
    calc();
  });
  $('#printBtn').addEventListener('click',()=>{ window.print(); });
  $('#csvBtn').addEventListener('click',()=>{
    const rows = [
      ['指標','値'],
      ['DIO（日）', $('#vDIO').textContent.replace(' 日','')],
      ['DSO（日）', $('#vDSO').textContent.replace(' 日','')],
      ['DPO（日）', $('#vDPO').textContent.replace(' 日','')],
      ['CCC（日）', $('#vCCC').textContent.replace(' 日','')]
    ];
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ccc_result.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $('#helpBtn').addEventListener('click',()=>{
    const g = document.getElementById('guide');
    g.style.display = g.style.display==='none' ? 'block':'none';
    g.scrollIntoView({behavior:'smooth',block:'start'});
  });

  // init
  calc();
})();
</script>
</body>
</html>
